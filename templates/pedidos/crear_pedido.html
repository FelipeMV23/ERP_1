{% load static %}
{% load widget_tweaks %}

<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Crear Pedido</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="{% static 'css/crear_pedido.css' %}" />
</head>
<body>

<header>
  {% include 'navegacion/nav.html' %}
</header>

<div class="container mt-5">
  <h2 class="text-center mb-4">Crear Pedido</h2>

  <div class="card shadow-sm mx-auto" style="max-width: 800px;">
    <div class="card-body">
      <form method="POST" id="pedidoForm" novalidate>
        {% csrf_token %}
            {% if form.non_field_errors %}
            <div class="alert alert-danger">
                {{ form.non_field_errors }}
            </div>
            {% endif %}
            {% if detalle_formset.non_form_errors %}
            <div class="alert alert-danger">
                {{ detalle_formset.non_form_errors }}
            </div>
            {% endif %}
        <!-- Cliente -->
        <div class="mb-3">
          <label for="{{ form.cliente.id_for_label }}" class="form-label fw-semibold">Cliente</label>
          {{ form.cliente|add_class:"form-select" }}
          {% if form.cliente.errors %}
            <div class="text-danger small">{{ form.cliente.errors }}</div>
          {% endif %}
        </div>

        <!-- Monto Total -->
        <div class="mb-3">
          <label for="{{ form.monto_total.id_for_label }}" class="form-label fw-semibold">Monto Total</label>
          {{ form.monto_total|add_class:"form-control" }}
          {% if form.monto_total.errors %}
            <div class="text-danger small">{{ form.monto_total.errors }}</div>
          {% endif %}
          <div class="form-text">Ingrese el valor total de venta del pedido.</div>
        </div>

        <hr />

        <!-- Detalles del pedido -->
        <h5 class="mb-3">Productos</h5>

        <div id="detalles-container">
          {{ detalle_formset.management_form }}
          {% for form in detalle_formset %}
            <div class="detalle-producto border rounded p-3 mb-3 bg-light position-relative">
              <div class="mb-3">
                <label for="{{ form.producto.id_for_label }}" class="form-label fw-semibold">Producto</label>
                {{ form.producto|add_class:"form-select" }}
                {% if form.producto.errors %}
                  <div class="text-danger small">{{ form.producto.errors }}</div>
                {% endif %}
              </div>

              <div class="mb-3">
                <label for="{{ form.cantidad.id_for_label }}" class="form-label fw-semibold">Cantidad</label>
                {{ form.cantidad|add_class:"form-control" }}
                {% if form.cantidad.errors %}
                  <div class="text-danger small">{{ form.cantidad.errors }}</div>
                {% endif %}
              </div>

              <button type="button" class="btn btn-danger btn-sm position-absolute top-0 end-0 m-2 remove-product-btn" title="Quitar producto">
                &times;
              </button>
            </div>
          {% endfor %}
        </div>

        <div class="text-center mb-4">
          <button type="button" id="add-product-btn" class="btn btn-outline-primary">
            + AÃ±adir Producto
          </button>
        </div>

        <div class="text-center">
          <button type="submit" class="btn btn-success px-5 fs-5">Crear Pedido</button>
        </div>

      </form>
    </div>
  </div>
</div>

<script>
  (function() {
    const addBtn = document.getElementById('add-product-btn');
    const detallesContainer = document.getElementById('detalles-container');
    const totalForms = document.getElementById('id_form-TOTAL_FORMS');

    function updateFormIndices() {
      const forms = detallesContainer.querySelectorAll('.detalle-producto');
      forms.forEach((form, index) => {
        form.querySelectorAll('input, select, textarea').forEach(input => {
          if (input.name) input.name = input.name.replace(/form-\d+-/, `form-${index}-`);
          if (input.id) input.id = input.id.replace(/form-\d+-/, `form-${index}-`);
        });
      });
      totalForms.value = forms.length;
    }

    addBtn.addEventListener('click', function() {
      const lastForm = detallesContainer.querySelector('.detalle-producto:last-of-type');
      const newForm = lastForm.cloneNode(true);

      // Limpiar valores
      newForm.querySelectorAll('input, select, textarea').forEach(input => {
        if (input.tagName === 'INPUT' || input.tagName === 'TEXTAREA') input.value = '';
        if (input.tagName === 'SELECT') input.selectedIndex = 0;
      });

      detallesContainer.appendChild(newForm);
      updateFormIndices();
    });

    detallesContainer.addEventListener('click', function(event) {
      if (event.target.classList.contains('remove-product-btn')) {
        const forms = detallesContainer.querySelectorAll('.detalle-producto');
        if (forms.length > 1) {
          event.target.closest('.detalle-producto').remove();
          updateFormIndices();
        } else {
          alert('Debe haber al menos un producto en el pedido.');
        }
      }
    });
  })();
</script>

</body>
</html>